<div id="forum-category" class="animate-fadeIn" data-category="{{ $category->id }}">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h3 class="mb-0 text-white">{{ $category->name }}</h3>
                <small class="text-muted">{{ $category->description }}</small>
            </div>
        </div>
        <small class="text-muted">
            {{ $category->threads->count() }} {{ Str::plural('thread', $category->threads->count()) }}
        </small>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <button id="backToCategories" class="btn btn-outline-light btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Categories
            </button>
        </div>
    </div>
    <!-- New Thread -->
    <div class="card forum-card mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">
                <i class="bi bi-pencil-square text-success"></i> Start New Discussion
            </h5>
            <form id="new-thread-form" data-category="{!! $category->id !!}">
                @csrf
                <div class="mb-3">
                    <input type="text" name="title" class="form-control bg-secondary text-white border-0"
                           placeholder="What's your question or topic?" required>
                </div>
                <div class="mb-3">
                    <textarea id="new-thread-body" name="body" rows="4" class="form-control bg-secondary text-white border-0"
          placeholder="Describe your topic in detail..."></textarea>
                </div>
                <div class="text-end">
                    <button class="btn btn-success">
                        Post Thread <i class="bi bi-send ms-1"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Threads -->
    @if($category->threads->count() > 0)
        <div class="d-flex flex-column gap-3">
            @foreach($category->threads as $thread)
                <div class="thread-card card forum-card p-3" data-thread="{{ $thread->id }}" style="cursor: pointer;">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="text-info mb-2"><i class="bi bi-chat-dots"></i> {{ $thread->title }}</h5>
                            <p class="text-muted small mb-2">{{ Str::limit($thread->body, 120) }}</p>
                            <div class="text-muted small">
                                <i class="bi bi-person"></i> {{ $thread->user->username }} â€¢
                                <i class="bi bi-clock"></i> {{ $thread->created_at->diffForHumans() }} â€¢
                                <i class="bi bi-chat-left-text"></i>
                                {{ $thread->replies_count ?? $thread->replies->count() }}
                                {{ Str::plural('reply', $thread->replies_count ?? $thread->replies->count()) }}
                            </div>
                        </div>
                        <div class="align-self-center text-secondary">
                            <i class="bi bi-chevron-right fs-5"></i>
                        </div>
                    </div>
                </div>
            @endforeach
        </div>
    @else
        <div class="text-center text-muted py-5">
            <i class="bi bi-inboxes fs-1 mb-2 d-block"></i>
            <p>No discussions yet. Be the first to start one!</p>
        </div>
    @endif
</div>
<!-- forum-script.blade.php -->
<script src="https://cdn.tiny.cloud/1/eeqmij25flkdyumonik6xoofb4fu0bb4sfg76ahpf6mogxet/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const forumContent = document.getElementById('forum-content');

    // ðŸ§  Utility: initialize TinyMCE if textarea exists
    function initTinyMCE() {
        if (typeof tinymce === 'undefined') return;

        tinymce.remove(); // clear previous instances

        // Thread reply editor
        if (document.querySelector('#reply-body')) {
            tinymce.init({
                selector: '#reply-body',
                plugins: 'image emoticons link lists code',
                toolbar: 'undo redo | bold italic underline | bullist numlist | emoticons | image link | code',
                menubar: false,
                skin: 'oxide-dark',
                content_css: 'dark',
                height: 300,
                branding: false,
                automatic_uploads: true,
                images_upload_url: '/forums/upload',
                file_picker_types: 'image',
                relative_urls: false,
                remove_script_host: false,
                convert_urls: true,
                images_upload_handler: uploadHandler
            });
        }

        // New thread editor
        if (document.querySelector('#new-thread-body')) {
            tinymce.init({
                selector: '#new-thread-body',
                plugins: 'image emoticons link lists code',
                toolbar: 'undo redo | bold italic underline | bullist numlist | emoticons | image link | code',
                menubar: false,
                skin: 'oxide-dark',
                content_css: 'dark',
                height: 300,
                branding: false,
                automatic_uploads: true,
                images_upload_url: '/forums/upload',
                file_picker_types: 'image',
                relative_urls: false,
                remove_script_host: false,
                convert_urls: true,
                images_upload_handler: uploadHandler
            });
        }
    }

    // ðŸ§© Image upload handler shared by both editors
    function uploadHandler(blobInfo, success, failure) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/forums/upload');
        xhr.setRequestHeader('X-CSRF-TOKEN', document.querySelector("meta[name='csrf-token']").content);
        xhr.onload = function() {
            if (xhr.status !== 200) {
                failure('HTTP Error: ' + xhr.status);
                return;
            }
            const json = JSON.parse(xhr.responseText);
            if (!json || typeof json.location != 'string') {
                failure('Invalid JSON: ' + xhr.responseText);
                return;
            }
            success(json.location);
        };
        const formData = new FormData();
        formData.append('file', blobInfo.blob(), blobInfo.filename());
        xhr.send(formData);
    }

    // ðŸ§­ Load a category
    document.querySelectorAll('.forum-card').forEach(card => {
        card.addEventListener('click', () => {
            const categoryId = card.dataset.category;
            fetch(`/forums/category/${categoryId}`)
                .then(res => res.text())
                .then(html => {
                    forumContent.innerHTML = html;
                    initTinyMCE(); // âœ… Initialize TinyMCE for new-thread form
                })
                .catch(err => {
                    console.error('Category load error:', err);
                    showNotification('Failed to load category', 'error');
                });
        });
    });

    // ðŸ”™ Back navigation (categories and threads)
    forumContent.addEventListener('click', e => {
        if (e.target.id === 'backToCategories' || e.target.closest('#backToCategories')) {
            window.location.href = '/forums';
        }

        if (e.target.id === 'backToCategory' || e.target.closest('#backToCategory')) {
            const container = e.target.closest('.animate-fadeIn');
            const category_id = container ? container.dataset.category : null;

            if (category_id) {
                fetch(`/forums/category/${category_id}`)
                    .then(res => res.text())
                    .then(html => {
                        forumContent.innerHTML = html;
                        initTinyMCE(); // âœ… reinit for new-thread form
                    })
                    .catch(err => {
                        console.error('Back to category error:', err);
                        window.location.reload();
                    });
            } else {
                window.location.reload();
            }
        }
    });

    // ðŸ§¨ Load a thread
    forumContent.addEventListener('click', e => {
        const threadCard = e.target.closest('.thread-card');
        if (!threadCard) return;
        const threadId = threadCard.dataset.thread;
        if (!threadId) return;

        fetch(`/forums/thread/${threadId}`)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                return res.text();
            })
            .then(html => {
                forumContent.innerHTML = html;
                initTinyMCE(); // âœ… initialize reply editor
            })
            .catch(err => {
                console.error('Thread load error:', err);
                showNotification('Failed to load thread', 'error');
            });
    });

    // ðŸ“¨ Handle thread + reply form submissions
    document.addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;

        // âœ… Collect TinyMCE data before sending
        if (typeof tinymce !== 'undefined') {
            tinymce.triggerSave();
        }

        // New thread form
        if (form.id === 'new-thread-form') {
            if (typeof tinymce !== 'undefined') tinymce.triggerSave();
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }
            const category_id = form.dataset.category;

            fetch(`/forums/category/${category_id}/thread`, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: formData
            })
            .then(res => {
                if (!res.ok) return res.text().then(t => { throw new Error(t) });
                return res.json();
            })

            .then(data => {
                if (data.success) {
                    form.reset();
                    showNotification('Thread posted successfully!', 'success');
                    // reload category to show new thread
                    fetch(`/forums/category/${category_id}`)
                        .then(r => r.text())
                        .then(html => {
                            forumContent.innerHTML = html;
                            initTinyMCE(); // reinit
                        });
                } else {
                    showNotification('Failed to post thread.', 'error');
                }
            })
            .catch(err => {
                showNotification('Failed to post thread.', 'error');
                console.error(err);
            });
        }

        // Reply form
        if (form.id === 'reply-form') {
            if (typeof tinymce !== 'undefined') tinymce.triggerSave();
            const formData = new FormData(form);
            const thread_id = form.dataset.thread;

            fetch(`/forums/thread/${thread_id}/reply`, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: formData
            })
            .then(res => {
                if (!res.ok) return res.text().then(t => { throw new Error(t) });
                return res.json();
            })

            .then(data => {
                if (data.success) {
                    forumContent.innerHTML = data.html;
                    showNotification('Reply posted successfully!', 'success');
                    initTinyMCE(); // âœ… reinit reply editor
                } else {
                    showNotification('Failed to post reply.', 'error');
                }
            })
            .catch(err => {
                showNotification('Failed to post reply.', 'error');
                console.error(err);
            });
        }
    });

    // Initialize editors for first load
    initTinyMCE();
});

// ðŸ”” Notification helper
function showNotification(message, type = 'info') {
    const n = document.createElement('div');
    n.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 3000);
}
</script>
@extends('layouts.forum')

@section('content')
<style>
    body {
        background-color: #0b1d3a;
    }
    .forum-card {
        background-color: #132d55;
        border: 1px solid #1f3b6e;
        color: #f1f3f5;
        transition: all 0.25s ease;
    }
    .forum-card:hover {
        background-color: #1a3b70;
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .card-title {
        color: #ffffff;
    }
    .text-muted {
        color: #9fb3d2 !important;
    }
</style>

<div id="forum-content">

    <!-- Header Card -->
    <div class="card border-0 mb-5 shadow-lg" style="background: linear-gradient(135deg, #0d6efd 0%, #1a73e8 100%);">
        <div class="card-body text-white d-flex justify-content-between align-items-center">
            <div>
                <h3 class="fw-bold mb-1">Welcome to the Community!</h3>
                <p class="mb-0">Share experiences, ask questions, and connect with fellow fishermen.</p>
            </div>
            <div class="d-none d-md-block">
                <i class="bi bi-water fs-1 text-light"></i>
            </div>
        </div>
    </div>

    <!-- Categories -->
    <div class="row g-4">
        @foreach($categories as $category)
            <div class="col-md-6 col-lg-4">
                <div class="card forum-card h-100" data-category="{{ $category->id }}" style="cursor: pointer;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="rounded-circle bg-primary bg-opacity-25 p-2">
                                {{-- Category Icon --}}
                                @php
                                    $icons = [
                                        'Equipment & Maintenance' => 'bi-wrench-adjustable',
                                        'Fish & Fishing Spots' => 'bi-geo-alt',
                                        'FAQ & Advice' => 'bi-question-circle',
                                        'General Discussion' => 'bi-chat-dots',
                                    ];
                                    $icon = $icons[$category->name] ?? 'bi-bubble';
                                @endphp
                                <i class="bi {{ $icon }} text-primary fs-5"></i>
                            </div>
                            <span class="badge bg-secondary">{{ $category->threads_count }} discussions</span>
                        </div>
                        <h5 class="card-title fw-semibold">{{ $category->name }}</h5>
                        <p class="card-text text-muted small">{{ $category->description }}</p>
                    </div>
                    <div class="card-footer bg-transparent border-0 text-muted small d-flex align-items-center">
                        Click to explore <i class="bi bi-arrow-right-short ms-1"></i>
                    </div>
                </div>
            </div>
        @endforeach
    </div>
</div>

@include('forums.forum-script')
@endsection

<style>
    body {
        background-color: #0b1d3a;
        color: #f1f3f5;
    }
    .forum-card {
        background-color: #132d55;
        border: 1px solid #1f3b6e;
        color: #f1f3f5;
        transition: all 0.25s ease;
    }
    .forum-card:hover {
        background-color: #1a3b70;
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .text-muted {
        color: #9fb3d2 !important;
    }
</style>

<div id="forum-thread" class="animate-fadeIn" data-category="{{ $category_id }}">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button id="backToCategory" class="btn btn-outline-light btn-sm">
            <i class="bi bi-arrow-left"></i> Back 
        </button>
        <small class="text-muted">
            {{ $thread->replies->count() }} {{ Str::plural('comment', $thread->replies->count()) }}
        </small>
    </div>

    <!-- Main Thread -->
    <div class="card forum-card mb-4">
        <div class="card-body d-flex">
            <div class="text-center me-3 vote-buttons" data-type="thread" data-id="{{ $thread->id }}">
                <button class="btn btn-sm text-secondary upvote"><i class="bi bi-hand-thumbs-up"></i></button>
                <div class="fw-bold my-2 score {{ ($thread->upvotes - $thread->downvotes) > 0 ? 'text-success' : (($thread->upvotes - $thread->downvotes) < 0 ? 'text-danger' : 'text-secondary') }}">
                    {{ $thread->upvotes - $thread->downvotes }}
                </div>
                <button class="btn btn-sm text-secondary downvote"><i class="bi bi-hand-thumbs-down"></i></button>
            </div>

            <div class="flex-grow-1">
                <h5 class="fw-bold text-white mb-2">{{ $thread->title }}</h5>
                <p class="text-light">{{ $thread->body }}</p>
                <div class="border-top border-secondary pt-2 small text-muted">
                    <i class="bi bi-person"></i> {{ $thread->user->username }} â€¢
                    <i class="bi bi-clock"></i> {{ $thread->created_at->diffForHumans() }}
                </div>
            </div>
        </div>
    </div>

    <!-- Replies -->
    <div class="mb-4">
        <h6 class="text-white mb-3"><i class="bi bi-chat-left-text text-info"></i> Comments</h6>
        @if($thread->replies->count() > 0)
            <div class="d-flex flex-column gap-3">
                @foreach($thread->replies as $reply)
                    <div class="card forum-card">
                        <div class="card-body d-flex">
                            <div class="text-center me-3 vote-buttons" data-type="reply" data-id="{{ $reply->id }}">
                                <button class="btn btn-sm text-secondary upvote"><i class="bi bi-hand-thumbs-up"></i></button>
                                <div class="fw-bold my-1 score {{ ($reply->upvotes - $reply->downvotes) > 0 ? 'text-success' : (($reply->upvotes - $reply->downvotes) < 0 ? 'text-danger' : 'text-secondary') }}">
                                    {{ $reply->upvotes - $reply->downvotes }}
                                </div>
                                <button class="btn btn-sm text-secondary downvote"><i class="bi bi-hand-thumbs-down"></i></button>
                            </div>
                            <div>
                                <p class="text-light mb-1">{{ $reply->body }}</p>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> {{ $reply->user->username }} â€¢
                                    <i class="bi bi-clock"></i> {{ $reply->created_at->diffForHumans() }}
                                </small>
                            </div>
                        </div>
                    </div>
                @endforeach
            </div>
        @else
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-left-dots fs-1 mb-2 d-block"></i>
                <p>No comments yet. Be the first to reply!</p>
            </div>
        @endif
    </div>

     <!-- Reply Form -->
    <div class="card forum-card mt-5">
        <div class="card-body">
            <h6 class="text-white mb-3"><i class="bi bi-reply text-success"></i> Add Your Comment</h6>
            <form id="reply-form" data-thread="{!! $thread->id !!}">
                @csrf
                <div class="mb-3">
                    <textarea id="reply-body" name="body" rows="6" class="form-control bg-secondary text-white border-0"
                              placeholder="Write something cool..."></textarea>
                </div>
                <div class="text-end">
                    <button class="btn btn-success">
                        Post Comment <i class="bi bi-send ms-1"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- resources/views/layouts/forum.blade.php -->

<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>{{ config('app.name', 'Laravel') }} | Forums</title>

    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Optional custom forum CSS -->
    <style>
        body {
            background-color: #121212;
            color: #e9ecef;
            font-family: "Segoe UI", system-ui, sans-serif;
        }
        a, a:hover {
            text-decoration: none;
        }
        .forum-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .rounded-circle {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50% !important;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="{{ route('forums.index') }}">ðŸŽ£ Fishermen Forums</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarForum" aria-controls="navbarForum" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarForum">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a href="{{ route('dashboard') }}" class="nav-link">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ route('forums.index') }}" class="nav-link active">Forums</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            {{ Auth::user()->username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ route('profile.edit') }}">Profile</a></li>
                            <li>
                                <form method="POST" action="{{ route('logout') }}">
                                    @csrf
                                    <button type="submit" class="dropdown-item text-danger">Log Out</button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-4">
        @yield('content')
    </main>
</body>
</html>
<?php
// routes/web.php

use App\Http\Controllers\MarketplaceController;
use App\Http\Controllers\MessageController;
use App\Http\Controllers\ProfileController;
use App\Http\Controllers\RiskPredictionController; 
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ProductController;
use App\Http\Controllers\FishermanController;
use App\Models\User;
use App\Http\Controllers\ForumController;

Route::get('/', function () {
    return view('welcome');
});

Route::middleware(['auth', 'verified'])->group(function () {
    Route::get('/dashboard', function () {
        return view('dashboard');
    })->name('dashboard');

    Route::get('/dashboard/risk', [RiskPredictionController::class, 'showForm'])->name('risk-form');
    Route::post('/dashboard/risk', [RiskPredictionController::class, 'predict'])->name('predict-risk');
    Route::get('/dashboard/risk/history', [RiskPredictionController::class, 'history'])->name('risk-history');
    Route::get('/api/risk/latest', [RiskPredictionController::class, 'latest'])->name('risk-latest');
});

Route::middleware('auth')->group(function () {
    Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
});

require __DIR__.'/auth.php';

Route::get('/test-profile', function () {
    $user = User::first();

    if (! $user) {
        return response()->json(['error' => 'No users found'], 404);
    }

    // Create a profile if none exists; otherwise return the existing one
    $profile = $user->fishermanProfile;
    if (! $profile) {
        $profile = $user->fishermanProfile()->create([
            'vessel_name' => 'Blue Dolphin',
            'vessel_type' => 'bangka',
        ]);
    }

    return response()->json($profile);
});

// Marketplace routes (public - no authentication required)

Route::get('/marketplace', [MarketplaceController::class, 'index'])->name('marketplace.index');
Route::get('/marketplace/shop', [MarketplaceController::class, 'shop'])->name('marketplace.shop');

// Messaging routes (requires authentication)
Route::middleware('auth')->group(function () {
    Route::get('/marketplace/message/{conversationId}', [MessageController::class, 'show'])->name('marketplace.message');
    Route::get('/marketplace/product/{productId}/message', [MessageController::class, 'startConversation'])->name('marketplace.message.product');
    Route::get('/api/conversations/{conversationId}/messages', [MessageController::class, 'getMessages']);
    Route::post('/api/conversations/{conversationId}/messages', [MessageController::class, 'sendMessage']);
});


Route::middleware(['auth'])->group(function () {
    Route::get('/forums', [ForumController::class, 'index'])->name('forums.index');
    Route::get('/forums/category/{id}', [ForumController::class, 'showCategory'])->name('forums.category');
    Route::get('/forums/thread/{id}', [ForumController::class, 'showThread'])->name('forums.thread');
    Route::post('/forums/category/{id}/thread', [ForumController::class, 'storeThread'])->name('forums.storeThread');
    Route::post('/forums/thread/{id}/reply', [ForumController::class, 'storeReply'])->name('forums.storeReply');
    Route::post('/forums/thread/{id}/upvote', [ForumController::class, 'upvoteThread'])->name('forums.upvoteThread');
    Route::post('/forums/thread/{id}/downvote', [ForumController::class, 'downvoteThread'])->name('forums.downvoteThread');
    Route::post('/forums/reply/{id}/upvote', [ForumController::class, 'upvoteReply'])->name('forums.upvoteReply');
    Route::post('/forums/reply/{id}/downvote', [ForumController::class, 'downvoteReply'])->name('forums.downvoteReply');
    Route::post('/forums/upload', [ForumController::class, 'uploadImage'])
    ->name('forums.upload')
    ->middleware('auth');

});


// Fisherman routes (requires authentication + fisherman role)

Route::middleware(['auth'])->prefix('fisherman')->name('fisherman.')->group(function () {
    // Fisherman Dashboard (will include safety navigation/ML features later)
    Route::get('/dashboard', [FishermanController::class, 'dashboard'])->name('dashboard');
    
    // Product Management (CRUD)
    Route::resource('products', ProductController::class)->except(['show']);
    
    // Message Inbox
    Route::get('/messages', [FishermanController::class, 'inbox'])->name('messages');
});

<?php
// app/Http/Controllers/ForumController.php

namespace App\Http\Controllers;

use App\Models\ForumCategory;
use App\Models\ForumThread;
use App\Models\ForumReply;
use Illuminate\Http\Request;

class ForumController extends Controller
{
    public function index()
    {
        $categories = ForumCategory::withCount('threads')->get();
        return view('forums.index', compact('categories'));
    }

    public function showCategory($id)
    {
        $category = ForumCategory::with('threads.user')->findOrFail($id);
        return view('forums.category', compact('category'));
    }

    public function showThread($id)
    {
        $thread = ForumThread::with(['user', 'replies.user'])->findOrFail($id);

        return view('forums.thread', [
            'thread' => $thread,
            'category_id' => $thread->category_id,
        ]);
    }

    public function storeThread(Request $request, $category_id)
    {
        $validator = validator($request->all(), [
            'title' => 'required|string|max:255',
            'body'  => 'required|string',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'errors' => $validator->errors()
            ], 422);
        }

        $thread = ForumThread::create([
            'category_id' => $category_id,
            'user_id' => auth()->id(),
            'title' => $request->title,
            'body' => $request->body,   // âœ… no JSON encoding
        ]);

        if ($request->ajax()) {
            $html = view('forums.partials.thread-card', [
                'thread' => $thread->load('user')
            ])->render();

            return response()->json([
                'success' => true,
                'html' => $html,   // âœ… returns HTML ready to insert
            ]);
        }

        return redirect()->route('forums.category', $category_id);
    }

    public function storeReply(Request $request, $thread_id)
    {
        $request->validate([
            'body' => 'required|string'
        ]);

        ForumReply::create([
            'thread_id' => $thread_id,
            'user_id' => auth()->id(),
            'body' => $request->body,  // âœ… no JSON encoding
        ]);

        if ($request->ajax()) {

            $thread = ForumThread::with(['user', 'replies.user'])->findOrFail($thread_id);

            $html = view('forums.partials.reply', [
                'replies' => $thread->replies
            ])->render();

            return response()->json([
                'success' => true,
                'html' => $html,  // âœ… returns only replies section
            ]);
        }

        return back();
    }

    public function uploadImage(Request $request)
    {
        $request->validate([
            'file' => 'required|image|mimes:jpg,jpeg,png,gif,webp|max:5120',
        ]);

        $path = $request->file('file')->store('public/forum_images');
        $url = asset(str_replace('public', 'storage', $path));

        return response()->json(['location' => $url]);
    }
}


<?php
// app/Models/ForumCategory.php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class ForumCategory extends Model
{
    use HasFactory;

    protected $fillable = ['name', 'description'];

    // Add this for automatic eager loading
    protected $with = ['threads.user'];

    // ðŸ‘‡ specify 'category_id' as the foreign key to avoid 'forum_category_id' assumption
    public function threads()
    {
        return $this->hasMany(ForumThread::class, 'category_id');
    }

    // Add this method to get threads count efficiently
    public function getThreadsCountAttribute()
    {
        return $this->threads->count();
    }
}

<?php
//  app/Models/ForumReply.php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class ForumReply extends Model
{
    use HasFactory;

    protected $fillable = ['thread_id', 'user_id', 'body', 'upvotes', 'downvotes'];

    // belongs to thread via thread_id
    public function thread()
    {
        return $this->belongsTo(ForumThread::class, 'thread_id');
    }

    // belongs to user via user_id
    public function user()
    {
        return $this->belongsTo(User::class, 'user_id');
    }
}

<?php
// app/Models/ForumThread.php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class ForumThread extends Model
{
    use HasFactory;

    protected $fillable = ['category_id', 'user_id', 'title', 'body', 'upvotes', 'downvotes'];

    // Add this for automatic eager loading
    protected $with = ['user', 'replies.user'];

    // belongs to category via category_id
    public function category()
    {
        return $this->belongsTo(ForumCategory::class, 'category_id');
    }

    // belongs to user via user_id
    public function user()
    {
        return $this->belongsTo(User::class, 'user_id');
    }

    // has many replies
    public function replies()
    {
        return $this->hasMany(ForumReply::class, 'thread_id');
    }

    // Add this method to get replies count efficiently
    public function getRepliesCountAttribute()
    {
        return $this->replies->count();
    }
}



